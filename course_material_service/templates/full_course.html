{% extends "base.html" %}

{% block title %}{{ course_title }} - Full Course - ALPHA{% endblock %}

{% block content %}
<div class="w-full px-6 mb-10">
  <!-- Hero header -->
  <div class="relative overflow-hidden rounded-2xl mb-8">
    <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 opacity-90"></div>
    <div class="relative p-8 md:p-12 text-white">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">{{ course_title }}</h1>
          <p class="mt-2 text-white/90">Full course: Videos, Readings, Quizzes with Coursera-like navigation.</p>
        </div>
        <a href="/exports"
          class="inline-block bg-white text-gray-900 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Saved
          Courses</a>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-12 gap-6">
    <!-- Sidebar: modules as pages -->
    <aside class="col-span-12 md:col-span-3 lg:col-span-2">
      <div class="sticky top-6 bg-white rounded-2xl shadow-xl p-5 overflow-y-auto max-h-[calc(100vh-4rem)]">
        <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Course Modules</h2>
        {% if modules_output %}
        <nav class="space-y-6" aria-label="Module navigation">
          {% for module in modules_output %}
          <div class="module-group">
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 px-2">{{ module.title }}</h3>
            <div class="space-y-1">
              {% for lesson in module.lessons %}
              {% set info = lesson.info %}
              <button
                class="module-tab w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition-colors group"
                data-module="{{ info.number }}">
                <span
                  class="flex-shrink-0 inline-flex h-6 w-6 items-center justify-center text-xs font-semibold rounded-full bg-gray-100 text-gray-500 group-hover:bg-indigo-200 group-hover:text-indigo-800 transition-colors">{{
                  info.number }}</span>
                <span class="truncate text-sm font-medium">{{ info.title }}</span>
              </button>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </nav>
        {% else %}
        <p class="text-gray-500 text-sm">No modules yet.</p>
        {% endif %}
      </div>
    </aside>

    <!-- Main content: one page per module with subheadings -->
    <section class="col-span-12 md:col-span-9 lg:col-span-10">
      {% if modules_output %}
      {% for module in modules_output %}
      {% for lesson in module.lessons %}
      {% set info = lesson.info %}
      {% set vpack = lesson.assets.get('video_script') or {} %}
      {% set video = vpack.get('content') %}
      {% set video_url = vpack.get('video_url') %}
      {% set captions_url = vpack.get('captions_url') %}
      {% set chapters_url = vpack.get('chapters_url') %}
      {% set reading_asset = lesson.assets.get('reading_material') or {} %}
      {% set reading = reading_asset.get('content') %}
      {% set quiz_asset = lesson.assets.get('quiz_questions') or {} %}
      {% set quiz = quiz_asset.get('content') %}

      <div id="page-module-{{ info.number }}"
        class="module-page rounded-2xl bg-white shadow-xl p-0 mb-8 border border-gray-100 overflow-hidden hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span
              class="inline-flex h-8 w-8 items-center justify-center text-sm font-semibold rounded-full bg-indigo-600 text-white">{{
              info.number }}</span>
            <h2 class="text-xl font-semibold text-gray-900">{{ info.title }}</h2>
          </div>
          <div class="text-sm text-gray-600 space-x-3 flex">
            {% if video_url or video %}
            <button type="button" class="subpage-tab hover:text-gray-900" data-module="{{ info.number }}"
              data-subpage="video">Video</button>
            {% endif %}
            {% if reading and reading.text %}
            <button type="button" class="subpage-tab hover:text-gray-900" data-module="{{ info.number }}"
              data-subpage="reading">Reading</button>
            {% endif %}
            {% if quiz %}
            <button type="button" class="subpage-tab hover:text-gray-900" data-module="{{ info.number }}"
              data-subpage="quiz">Quiz</button>
            {% endif %}
          </div>
        </div>
        <div class="px-6 py-5">
          {% if info.summary %}
          <p class="text-gray-700 mb-4">{{ info.summary }}</p>
          {% endif %}

          <!-- Video section -->
          <div id="subpage-video-{{ info.number }}" class="subpage-section mt-2 hidden" data-subpage="video"
            data-module="{{ info.number }}">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Video</h3>
            {% if video_url %}
            <div class="mb-4">
              <video class="w-full rounded-lg shadow" controls preload="metadata">
                <source src="{{ video_url }}" type="video/mp4" />
                {% if captions_url %}
                <track kind="subtitles" src="{{ captions_url }}" srclang="en" label="English" default />
                {% endif %}
                {% if chapters_url %}
                <track kind="chapters" src="{{ chapters_url }}" srclang="en" label="Chapters" />
                {% endif %}
              </video>
              <p class="text-gray-500 text-sm mt-1">Narration voice: {{ voice }}</p>
            </div>
            {% endif %}
            {% if video %}
            {% if video.hook %}<p class="text-gray-800"><strong>Hook:</strong> {{ video.hook }}</p>{% endif %}
            {% if video.outline %}
            <h4 class="font-semibold mt-4">Outline</h4>
            <ul class="list-disc pl-6 text-gray-700">
              {% for item in video.outline %}
              <li>{{ item.timestamp }} — {{ item.topic }}</li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if video.narration %}
            <h4 class="font-semibold mt-4">Narration</h4>
            <ul class="list-disc pl-6 text-gray-700">
              {% for block in video.narration %}
              <li class="mb-2">
                <strong>{{ block.section }}</strong>: {{ block.summary }}<br />
                <span class="text-gray-700">{{ block.script }}</span>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if video.recap %}<p class="mt-3"><strong>Recap:</strong> {{ video.recap }}</p>{% endif %}
            {% if video.call_to_action %}<p><strong>Call to action:</strong> {{ video.call_to_action }}</p>{% endif %}
            {% else %}
            <p class="text-gray-600">No video content for this module.</p>
            {% endif %}
          </div>

          <!-- Reading section -->
          <div id="subpage-reading-{{ info.number }}" class="subpage-section mt-8 hidden" data-subpage="reading"
            data-module="{{ info.number }}">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Reading</h3>
            {% if reading %}
            {% if reading.text %}
            <!-- PDF Viewer UI -->
            <div
              class="pdf-viewer-container flex flex-col h-[850px] bg-gray-700 rounded-lg overflow-hidden border border-gray-600 shadow-2xl">
              <!-- Toolbar -->
              <div
                class="pdf-toolbar bg-gray-800 text-gray-300 px-4 py-3 flex items-center justify-between border-b border-gray-900 shadow-md z-10">
                <div class="flex items-center space-x-4">
                  <span class="font-semibold text-white tracking-wide text-sm">{{ info.title }}.pdf</span>
                </div>
                <div class="flex items-center space-x-2 bg-gray-700 rounded-lg px-2 py-1">
                  <button class="hover:text-white p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg></button>
                  <span class="text-xs font-mono text-white">100%</span>
                  <button class="hover:text-white p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg></button>
                </div>
                <div class="flex items-center space-x-4">
                  <button class="hover:text-white transition-colors" title="Download">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                  </button>
                  <button class="hover:text-white transition-colors" title="Print">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                      </path>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Scrollable Viewport -->
              <div class="pdf-viewport flex-1 bg-gray-500 overflow-y-auto flex justify-center p-8">
                <!-- A4 Page Simulation -->
                <div
                  class="pdf-page bg-white shadow-2xl w-full max-w-[800px] min-h-[1123px] p-12 relative mx-auto text-gray-900 transition-transform duration-200"
                  style="font-family: 'Times New Roman', Times, serif; font-size: 14pt; line-height: 1.6;">

                  <style>
                    /* Professional Document Styling */
                    .pdf-content h1,
                    .pdf-content h2,
                    .pdf-content h3,
                    .pdf-content h4 {
                      font-family: 'Times New Roman', Times, serif;
                      color: #111827;
                      margin-top: 1.5em;
                      margin-bottom: 0.5em;
                      line-height: 1.2;
                    }

                    .pdf-content h1 {
                      font-size: 28pt;
                      font-weight: bold;
                      border-bottom: 2px solid #000;
                      padding-bottom: 0.2em;
                    }

                    .pdf-content h2 {
                      font-size: 22pt;
                      font-weight: bold;
                      border-bottom: 1px solid #e5e7eb;
                      padding-bottom: 0.2em;
                    }

                    .pdf-content h3 {
                      font-size: 18pt;
                      font-weight: bold;
                    }

                    .pdf-content h4 {
                      font-size: 16pt;
                      font-weight: bold;
                      font-style: italic;
                    }

                    .pdf-content p {
                      margin-bottom: 1em;
                      text-align: justify;
                    }

                    .pdf-content ul,
                    .pdf-content ol {
                      margin-bottom: 1em;
                      padding-left: 2em;
                    }

                    .pdf-content ul {
                      list-style-type: disc;
                    }

                    .pdf-content ol {
                      list-style-type: decimal;
                    }

                    .pdf-content li {
                      margin-bottom: 0.5em;
                    }

                    .pdf-content pre {
                      background-color: #f3f4f6;
                      padding: 1em;
                      border-radius: 4px;
                      font-family: 'Courier New', Courier, monospace;
                      font-size: 11pt;
                      overflow-x: auto;
                      margin-bottom: 1em;
                      border: 1px solid #e5e7eb;
                    }

                    .pdf-content code {
                      font-family: 'Courier New', Courier, monospace;
                      background-color: #f3f4f6;
                      padding: 0.1em 0.3em;
                      border-radius: 2px;
                      font-size: 0.9em;
                    }

                    .pdf-content pre code {
                      background-color: transparent;
                      padding: 0;
                    }

                    .pdf-content blockquote {
                      border-left: 4px solid #d1d5db;
                      padding-left: 1em;
                      margin-left: 0;
                      margin-right: 0;
                      margin-bottom: 1em;
                      font-style: italic;
                      color: #4b5563;
                    }

                    .pdf-content table {
                      width: 100%;
                      border-collapse: collapse;
                      margin-bottom: 1em;
                      font-size: 12pt;
                    }

                    .pdf-content th,
                    .pdf-content td {
                      border: 1px solid #d1d5db;
                      padding: 0.5em;
                      text-align: left;
                    }

                    .pdf-content th {
                      background-color: #f9fafb;
                      font-weight: bold;
                    }
                  </style>

                  <!-- Document Header -->
                  <div class="border-b-2 border-black pb-4 mb-8 flex justify-between items-end">
                    <div>
                      <h1 class="text-2xl font-bold uppercase tracking-wider text-black mb-1"
                        style="font-family: 'Times New Roman', Times, serif;">{{ info.title }}</h1>
                      <p class="text-sm text-gray-600 italic">Module {{ info.number }} • Course Material</p>
                    </div>
                    <div class="text-right">
                      <div class="w-8 h-8 bg-black text-white flex items-center justify-center font-bold rounded-sm">A
                      </div>
                    </div>
                  </div>

                  <!-- Content -->
                  <div class="pdf-content">
                    {% if reading.text %}
                    {{ reading.text | markdown | safe }}
                    {% else %}
                    <!-- Fallback if text is not directly available, render sections -->
                    {% if reading.summary %}
                    <p class="font-bold mb-4">{{ reading.summary }}</p>
                    {% endif %}
                    {% for section in reading.sections %}
                    <h2>{{ section.heading }}</h2>
                    <div>{{ section.content | markdown | safe }}</div>
                    {% endfor %}
                    {% endif %}
                  </div>

                  <!-- Document Footer -->
                  <div
                    class="mt-12 pt-4 border-t border-gray-300 flex justify-between text-[10px] text-gray-500 font-sans">
                    <span>Alpha Learning Systems</span>
                    <span>Page 1</span>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            {% if reading.summary %}<p><strong>Summary:</strong> {{ reading.summary }}</p>{% endif %}
            {% if reading.sections %}
            <h4 class="font-semibold mt-2">Sections</h4>
            <ul class="list-disc pl-6 text-gray-700">
              {% for section in reading.sections %}
              <li class="mb-2">
                <strong>{{ section.heading }}</strong>
                {% if section.key_points %}
                <ul>
                  {% for point in section.key_points %}
                  <li>{{ point }}</li>
                  {% endfor %}
                </ul>
                {% endif %}
                <p>{{ section.content }}</p>
                {% if section.outcome_alignment %}
                <p class="muted">Outcomes: {{ section.outcome_alignment | join(", ") }}</p>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if reading.examples %}
            <h4 class="font-semibold mt-2">Examples</h4>
            <ul class="list-disc pl-6 text-gray-700">
              {% for example in reading.examples %}
              <li>
                <strong>{{ example.title }}</strong> — {{ example.description }}
                {% if example.outcome_alignment %}
                <span class="muted">(Outcomes: {{ example.outcome_alignment | join(", ") }})</span>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if reading.glossary %}
            <h4 class="font-semibold mt-2">Glossary</h4>
            <ul class="list-disc pl-6 text-gray-700">
              {% for term in reading.glossary %}
              <li><strong>{{ term.term }}</strong>: {{ term.definition }}</li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if reading.reflections %}
            <h4 class="font-semibold mt-2">Reflection prompts</h4>
            <ul class="list-disc pl-6 text-gray-700">
              {% for prompt in reading.reflections %}
              <li>{{ prompt }}</li>
              {% endfor %}
            </ul>
            {% endif %}
            {% endif %}
            {% else %}
            <p class="text-gray-600">No reading content for this module.</p>
            {% endif %}
          </div>

          <!-- Quiz section -->
          <div id="subpage-quiz-{{ info.number }}" class="subpage-section mt-8 hidden" data-subpage="quiz"
            data-module="{{ info.number }}">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Quiz</h3>
            {% if quiz and quiz.questions %}
            <!-- Exam-style start screen -->
            <div class="exam-intro rounded-xl border border-gray-200 bg-gray-50 p-5 mb-4"
              data-module="{{ info.number }}">
              <p class="text-gray-700 mb-2">This module has {{ quiz.questions|length }} questions. You can review
                rationales after submission.</p>
              <button type="button"
                class="start-quiz-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded"
                data-module="{{ info.number }}">Start Quiz</button>
            </div>
            <!-- Exam body (hidden until start) -->
            <form class="quiz-form exam-body hidden" id="quiz-form-{{ info.number }}">
              <div class="space-y-8">
                {% for question in quiz.questions %}
                {% set qidx = loop.index0 %}
                <div class="question bg-white p-6 rounded-xl border border-gray-200 shadow-sm transition-all"
                  data-answer="{{ question.answer }}" data-stem="{{ question.stem|e }}">
                  <div class="flex justify-between items-start mb-4">
                    <h4 class="text-lg font-medium text-gray-900">{{ question.stem }}</h4>
                    <span class="badge px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide hidden"
                      aria-live="polite"></span>
                  </div>

                  <div class="choice-list space-y-3">
                    {% for choice in question.choices %}
                    <label class="choice-item block relative cursor-pointer group">
                      <input type="radio" name="q{{ qidx }}-m{{ info.number }}" value="{{ choice.label }}"
                        class="peer sr-only" />
                      <div
                        class="p-4 rounded-lg border-2 border-gray-200 hover:border-indigo-300 peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition-all flex items-center">
                        <span
                          class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 font-bold mr-3 peer-checked:bg-indigo-600 peer-checked:text-white transition-colors">{{
                          choice.label }}</span>
                        <span class="text-gray-700 group-hover:text-gray-900">{{ choice.text }}</span>
                      </div>
                    </label>
                    {% endfor %}
                  </div>

                  {% if question.learning_outcome %}
                  <p class="mt-4 text-xs text-gray-400 uppercase tracking-wide font-semibold">Outcome: {{
                    question.learning_outcome }}</p>
                  {% endif %}

                  <div
                    class="rationale mt-4 p-4 bg-blue-50 text-blue-800 rounded-lg text-sm hidden border border-blue-100">
                    <strong>Explanation:</strong> {{ question.rationale or "No specific rationale provided." }}
                  </div>
                </div>
                {% endfor %}
              </div>

              <div
                class="quiz-actions mt-8 flex items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-200">
                <div class="quiz-result text-sm font-medium text-gray-700" id="quiz-result-{{ info.number }}"
                  aria-live="polite">
                  <span>Complete the quiz to see your score.</span>
                </div>
                <div class="flex gap-3">
                  <button type="button"
                    class="reset-quiz px-4 py-2 text-gray-600 hover:text-gray-900 font-medium hidden"
                    data-module="{{ info.number }}">Try Again</button>
                  <button type="button"
                    class="submit-quiz bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105"
                    data-module="{{ info.number }}">Submit Answers</button>
                </div>
              </div>
            </form>
            {% elif quiz and quiz.remediation %}
            <p class="text-gray-600">No questions provided. {{ quiz.remediation }}</p>
            {% else %}
            <p class="text-gray-600">No quiz content for this module.</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
      {% endfor %}
      {% else %}
      <p class="text-gray-600">No modules generated.</p>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    function evaluateQuiz(form) {
      const questions = Array.from(form.querySelectorAll('.question'));
      let correct = 0;
      let wrong = 0;

      questions.forEach((q, idx) => {
        // Reset state
        q.classList.remove('border-green-500', 'border-red-500', 'ring-2', 'ring-green-100', 'ring-red-100');
        const badge = q.querySelector('.badge');
        if (badge) {
          badge.classList.add('hidden');
          badge.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
        }

        const radios = q.querySelectorAll('input[type="radio"]');
        let selected = '';
        radios.forEach(r => { if (r.checked) selected = r.value; });

        const expected = (q.getAttribute('data-answer') || '').trim();
        const rationale = q.querySelector('.rationale');

        if (!selected) {
          wrong += 1;
          q.classList.add('border-yellow-500', 'ring-2', 'ring-yellow-100');
          if (badge) {
            badge.textContent = 'Unanswered';
            badge.classList.remove('hidden');
            badge.classList.add('bg-yellow-100', 'text-yellow-800');
          }
          if (rationale) rationale.classList.remove('hidden');
        } else if (selected.toUpperCase() === expected.toUpperCase()) {
          correct += 1;
          q.classList.add('border-green-500', 'ring-2', 'ring-green-100');
          if (badge) {
            badge.textContent = 'Correct';
            badge.classList.remove('hidden');
            badge.classList.add('bg-green-100', 'text-green-800');
          }
          if (rationale) rationale.classList.add('hidden');
        } else {
          wrong += 1;
          q.classList.add('border-red-500', 'ring-2', 'ring-red-100');
          if (badge) {
            badge.textContent = 'Incorrect';
            badge.classList.remove('hidden');
            badge.classList.add('bg-red-100', 'text-red-800');
          }
          if (rationale) rationale.classList.remove('hidden');
        }
      });

      const total = questions.length || 1;
      const percent = Math.round((correct / total) * 100);
      const res = form.querySelector('.quiz-result');

      if (res) {
        let msgClass = percent >= 70 ? 'text-green-600' : 'text-gray-700';
        res.innerHTML = `<span class="${msgClass} font-bold text-lg">Score: ${correct}/${total} (${percent}%)</span>`;
      }

      // Toggle buttons
      form.querySelector('.submit-quiz').classList.add('hidden');
      form.querySelector('.reset-quiz').classList.remove('hidden');
    }

    function resetQuiz(form) {
      const questions = Array.from(form.querySelectorAll('.question'));
      questions.forEach(q => {
        q.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500', 'ring-2', 'ring-green-100', 'ring-red-100', 'ring-yellow-100');
        const badge = q.querySelector('.badge');
        if (badge) badge.classList.add('hidden');
        const rationale = q.querySelector('.rationale');
        if (rationale) rationale.classList.add('hidden');

        const radios = q.querySelectorAll('input[type="radio"]');
        radios.forEach(r => r.checked = false);
      });

      const res = form.querySelector('.quiz-result');
      if (res) res.innerHTML = '<span>Complete the quiz to see your score.</span>';

      form.querySelector('.submit-quiz').classList.remove('hidden');
      form.querySelector('.reset-quiz').classList.add('hidden');
    }

    document.addEventListener('click', function (e) {
      const startBtn = e.target.closest('.start-quiz-button');
      if (startBtn) {
        const mod = startBtn.getAttribute('data-module');
        const intro = document.querySelector('.exam-intro[data-module="' + mod + '"]');
        const form = document.getElementById('quiz-form-' + mod);
        if (intro) intro.classList.add('hidden');
        if (form) form.classList.remove('hidden');
        return;
      }

      const submitBtn = e.target.closest('.submit-quiz');
      if (submitBtn) {
        const mod = submitBtn.getAttribute('data-module');
        const form = document.getElementById('quiz-form-' + mod);
        if (form) evaluateQuiz(form);
        return;
      }

      const resetBtn = e.target.closest('.reset-quiz');
      if (resetBtn) {
        const mod = resetBtn.getAttribute('data-module');
        const form = document.getElementById('quiz-form-' + mod);
        if (form) resetQuiz(form);
        return;
      }
    });

    // Module page switching
    const moduleTabs = document.querySelectorAll('.module-tab');
    const modulePages = Array.from(document.querySelectorAll('.module-page'));
    function setActiveModule(mod) {
      modulePages.forEach(el => el.classList.add('hidden'));
      const page = document.getElementById('page-module-' + mod);
      if (page) {
        page.classList.remove('hidden');

        // Determine the first available tab for this module
        const availableTabs = Array.from(page.querySelectorAll('.subpage-tab'));
        let defaultSub = 'video';
        if (availableTabs.length > 0) {
          defaultSub = availableTabs[0].getAttribute('data-subpage');
        }

        // Use previously selected subpage if valid, else default
        const targetSub = (currentSubpage[mod] && page.querySelector(`.subpage-tab[data-subpage="${currentSubpage[mod]}"]`))
          ? currentSubpage[mod]
          : defaultSub;

        setActiveSubpage(mod, targetSub);
      }

      moduleTabs.forEach(btn => {
        const active = btn.getAttribute('data-module') === String(mod);
        btn.classList.toggle('bg-gray-100', active);
        btn.classList.toggle('text-gray-900', active);
      });
    }

    // Subpage switching per module (video/reading/quiz)
    const subTabs = document.querySelectorAll('.subpage-tab');
    const currentSubpage = {};
    function setActiveSubpage(mod, name) {
      currentSubpage[mod] = name;
      const sections = document.querySelectorAll('.subpage-section[data-module="' + mod + '"]');
      sections.forEach(s => s.classList.toggle('hidden', s.getAttribute('data-subpage') !== name));
      // Update active styling on subpage tabs for this module
      document.querySelectorAll('.subpage-tab[data-module="' + mod + '"]').forEach(btn => {
        const active = btn.getAttribute('data-subpage') === name;
        btn.classList.toggle('font-semibold', active);
        btn.classList.toggle('text-gray-900', active);
        btn.classList.toggle('text-gray-500', !active);
        btn.classList.toggle('bg-gray-100', active);
        btn.classList.toggle('rounded-md', true);
        btn.classList.toggle('px-3', true);
        btn.classList.toggle('py-1', true);
      });
      try {
        const hash = 'module-' + mod + ':' + name;
        history.replaceState(null, '', '#' + hash);
      } catch (e) { }
    }
    subTabs.forEach(btn => btn.addEventListener('click', () => {
      const mod = btn.getAttribute('data-module');
      const name = btn.getAttribute('data-subpage');
      setActiveSubpage(mod, name);
    }));
    moduleTabs.forEach(btn => btn.addEventListener('click', () => setActiveModule(btn.getAttribute('data-module'))));

    // Initialize from URL hash or default to first module
    const firstTab = moduleTabs[0];
    let startMod = firstTab ? firstTab.getAttribute('data-module') : null;
    let startSub = null;
    const hash = (location.hash || '').replace('#', '');
    if (hash && hash.startsWith('module-')) {
      const parts = hash.substring('module-'.length).split(':');
      if (parts[0]) startMod = parts[0];
      if (parts[1]) startSub = parts[1];
    }
    if (startMod) {
      setActiveModule(startMod);
      if (startSub) {
        // If a specific subpage was requested, try to switch to it
        const page = document.getElementById('page-module-' + startMod);
        if (page && page.querySelector(`.subpage-tab[data-subpage="${startSub}"]`)) {
          setActiveSubpage(startMod, startSub);
        }
      }
    }
  })();
</script>
{% endblock %}