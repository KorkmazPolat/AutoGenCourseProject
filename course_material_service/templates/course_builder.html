{% extends "base.html" %}

{% block title %}Course Builder - Visual Canvas{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Canvas and Grid */
    .canvas-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 200px);
        background:
            linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px),
            linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
        background-color: #fafbfc;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .canvas-viewport {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: auto;
    }

    .canvas-content {
        position: relative;
        width: 3000px;
        height: 3000px;
    }

    /* Component Cards on Canvas */
    .canvas-component {
        position: absolute;
        min-width: 200px;
        max-width: 300px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: move;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .canvas-component:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .canvas-component.selected {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        z-index: 20;
    }

    .canvas-component.dragging {
        opacity: 0.7;
        cursor: grabbing;
        z-index: 30;
    }

    /* Component Header */
    .component-header {
        padding: 12px 16px;
        border-bottom: 2px solid;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 12px 12px 0 0;
    }

    .component-header.video {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #f87171;
    }

    .component-header.quiz {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-color: #34d399;
    }

    .component-header.reading {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #60a5fa;
    }

    .component-header.assignment {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-color: #fbbf24;
    }

    /* Component Body */
    .component-body {
        padding: 16px;
    }

    .component-title {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        word-wrap: break-word;
    }

    .component-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
        word-wrap: break-word;
    }

    /* Connection Points */
    .connection-point {
        position: absolute;
        width: 14px;
        height: 14px;
        background: white;
        border: 3px solid #6366f1;
        border-radius: 50%;
        cursor: pointer;
        z-index: 50;
        transition: all 0.2s ease;
        pointer-events: all;
    }

    .connection-point:hover {
        width: 18px;
        height: 18px;
        background: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        transform: scale(1.2);
    }

    .connection-point.active {
        background: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.4);
        animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.4);
        }

        50% {
            box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.2);
        }
    }

    .connection-point.top {
        top: -7px;
        left: 50%;
        transform: translateX(-50%);
    }

    .connection-point.top:hover {
        transform: translateX(-50%) scale(1.2);
    }

    .connection-point.bottom {
        bottom: -7px;
        left: 50%;
        transform: translateX(-50%);
    }

    .connection-point.bottom:hover {
        transform: translateX(-50%) scale(1.2);
    }

    .connection-point.left {
        left: -7px;
        top: 50%;
        transform: translateY(-50%);
    }

    .connection-point.left:hover {
        transform: translateY(-50%) scale(1.2);
    }

    .connection-point.right {
        right: -7px;
        top: 50%;
        transform: translateY(-50%);
    }

    .connection-point.right:hover {
        transform: translateY(-50%) scale(1.2);
    }

    /* SVG Arrows */
    .arrow-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
    }

    .arrow-path {
        fill: none;
        stroke: #6366f1;
        stroke-width: 2;
        marker-end: url(#arrowhead);
        transition: stroke 0.2s ease;
    }

    .arrow-path:hover {
        stroke: #4f46e5;
        stroke-width: 3;
    }

    /* Toolbar */
    .floating-toolbar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 12px;
        display: flex;
        gap: 8px;
        z-index: 100;
    }

    .tool-button {
        padding: 12px 20px;
        border-radius: 10px;
        border: 2px solid transparent;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }

    .tool-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .tool-button.active {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border-color: #4f46e5;
    }

    .tool-button.video {
        border-color: #f87171;
    }

    .tool-button.quiz {
        border-color: #34d399;
    }

    .tool-button.reading {
        border-color: #60a5fa;
    }

    .tool-button.assignment {
        border-color: #fbbf24;
    }

    /* Properties Panel */
    .properties-panel {
        position: fixed;
        right: -350px;
        top: 0;
        width: 350px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 200;
        overflow-y: auto;
    }

    .properties-panel.open {
        right: 0;
    }

    .properties-header {
        padding: 20px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
    }

    .properties-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    /* Animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .canvas-component {
        animation: fadeIn 0.3s ease;
    }

    /* Mini Map */
    .minimap {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 200px;
        height: 150px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 2px solid #e5e7eb;
        z-index: 90;
        overflow: hidden;
    }

    .minimap-content {
        width: 100%;
        height: 100%;
        background:
            linear-gradient(90deg, rgba(99, 102, 241, 0.05) 1px, transparent 1px),
            linear-gradient(rgba(99, 102, 241, 0.05) 1px, transparent 1px);
        background-size: 10px 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="relative">
    <!-- Top Toolbar -->
    <div class="mb-6 bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-1">Visual Course Builder</h1>
                <p class="text-gray-600">Create your course structure with drag-and-drop components and connections</p>
            </div>
            <div class="flex gap-3">
                <button
                    class="px-5 py-2.5 bg-white border-2 border-gray-300 rounded-xl font-semibold text-gray-700 hover:border-gray-400 hover:bg-gray-50 transition-all">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Export
                </button>
                <button
                    class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 shadow-lg transition-all">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                        </path>
                    </svg>
                    Save Course
                </button>
            </div>
        </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-container">
        <div class="canvas-viewport" id="canvasViewport">
            <div class="canvas-content" id="canvasContent">
                <!-- SVG Layer for Arrows -->
                <svg class="arrow-svg" id="arrowSvg">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                        </marker>
                    </defs>
                </svg>

                <!-- Sample Components (for demonstration) -->
                <div class="canvas-component" style="left: 100px; top: 100px;" data-id="comp-1" data-type="video">
                    <div class="component-header video">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                </path>
                            </svg>
                            <span class="text-sm font-bold text-red-900">Video</span>
                        </div>
                        <button class="text-red-700 hover:text-red-900" onclick="deleteComponent('comp-1')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="component-body">
                        <div class="component-title">Introduction Video</div>
                        <div class="component-description">Welcome students and introduce the course objectives</div>
                    </div>
                    <div class="connection-point top"></div>
                    <div class="connection-point bottom"></div>
                    <div class="connection-point left"></div>
                    <div class="connection-point right"></div>
                </div>

                <div class="canvas-component" style="left: 450px; top: 100px;" data-id="comp-2" data-type="reading">
                    <div class="component-header reading">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18s-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                            <span class="text-sm font-bold text-blue-900">Reading</span>
                        </div>
                        <button class="text-blue-700 hover:text-blue-900" onclick="deleteComponent('comp-2')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="component-body">
                        <div class="component-title">Core Concepts</div>
                        <div class="component-description">Read about fundamental principles and theories</div>
                    </div>
                    <div class="connection-point top"></div>
                    <div class="connection-point bottom"></div>
                    <div class="connection-point left"></div>
                    <div class="connection-point right"></div>
                </div>

                <div class="canvas-component" style="left: 275px; top: 350px;" data-id="comp-3" data-type="quiz">
                    <div class="component-header quiz">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4">
                                </path>
                            </svg>
                            <span class="text-sm font-bold text-green-900">Quiz</span>
                        </div>
                        <button class="text-green-700 hover:text-green-900" onclick="deleteComponent('comp-3')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="component-body">
                        <div class="component-title">Knowledge Check</div>
                        <div class="component-description">Test your understanding with 5 questions</div>
                    </div>
                    <div class="connection-point top"></div>
                    <div class="connection-point bottom"></div>
                    <div class="connection-point left"></div>
                    <div class="connection-point right"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Toolbar -->
    <div class="floating-toolbar">
        <button class="tool-button video" onclick="addComponent('video')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                </path>
            </svg>
            Video
        </button>
        <button class="tool-button quiz" onclick="addComponent('quiz')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4">
                </path>
            </svg>
            Quiz
        </button>
        <button class="tool-button reading" onclick="addComponent('reading')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18s-3.332.477-4.5 1.253">
                </path>
            </svg>
            Reading
        </button>
        <button class="tool-button assignment" onclick="addComponent('assignment')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                </path>
            </svg>
            Assignment
        </button>
        <div style="width: 2px; background: #e5e7eb; margin: 0 4px;"></div>
        <button class="tool-button" id="connectionMode" onclick="toggleConnectionMode()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                </path>
            </svg>
            Connect
        </button>
    </div>

    <!-- Mini Map -->
    <div class="minimap">
        <div class="minimap-content"></div>
    </div>

    <!-- Properties Panel -->
    <div class="properties-panel" id="propertiesPanel">
        <div class="properties-header">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold">Component Properties</h3>
                <button onclick="closeProperties()" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="properties-body">
            <div class="form-group">
                <label class="form-label">Component Type</label>
                <input type="text" class="form-input" id="propType" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" id="propTitle" placeholder="Enter title...">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input form-textarea" id="propDescription"
                    placeholder="Enter description..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Duration (minutes)</label>
                <input type="number" class="form-input" id="propDuration" placeholder="e.g., 15">
            </div>
            <div class="form-group">
                <label class="form-label">Learning Outcomes</label>
                <textarea class="form-input form-textarea" id="propOutcomes"
                    placeholder="Enter learning outcomes (one per line)..."></textarea>
            </div>
            <button onclick="saveProperties()"
                class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 shadow-lg transition-all">
                Save Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let componentCounter = 4;
    let selectedComponent = null;
    let connectionMode = false;
    let connectionStart = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let connections = []; // Store all connections with order
    let connectionCounter = 1;

    // Add Component
    function addComponent(type) {
        const id = `comp-${componentCounter++}`;
        const canvasContent = document.getElementById('canvasContent');

        const typeConfig = {
            video: { icon: 'M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z', color: 'red', title: 'New Video', desc: 'Video content' },
            quiz: { icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', color: 'green', title: 'New Quiz', desc: 'Assessment questions' },
            reading: { icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18s-3.332.477-4.5 1.253', color: 'blue', title: 'New Reading', desc: 'Text-based content' },
            assignment: { icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z', color: 'yellow', title: 'New Assignment', desc: 'Project or task' }
        };

        const config = typeConfig[type];
        const component = document.createElement('div');
        component.className = 'canvas-component';
        component.style.left = '500px';
        component.style.top = '500px';
        component.dataset.id = id;
        component.dataset.type = type;

        component.innerHTML = `
            <div class="component-header ${type}">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-${config.color}-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${config.icon}"></path>
                    </svg>
                    <span class="text-sm font-bold text-${config.color}-900">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                </div>
                <button class="text-${config.color}-700 hover:text-${config.color}-900" onclick="deleteComponent('${id}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="component-body">
                <div class="component-title">${config.title}</div>
                <div class="component-description">${config.desc}</div>
            </div>
            <div class="connection-point top"></div>
            <div class="connection-point bottom"></div>
            <div class="connection-point left"></div>
            <div class="connection-point right"></div>
        `;

        canvasContent.appendChild(component);
        makeDraggable(component);
        setupConnectionPoints(component);
        component.addEventListener('click', () => selectComponent(id));
    }

    // Delete Component
    function deleteComponent(id) {
        const component = document.querySelector(`[data-id="${id}"]`);
        if (component) {
            // Remove all connections involving this component
            connections = connections.filter(conn => {
                if (conn.fromId === id || conn.toId === id) {
                    // Remove the SVG elements
                    if (conn.pathElement) conn.pathElement.remove();
                    if (conn.labelElement) conn.labelElement.remove();
                    return false;
                }
                return true;
            });
            component.remove();
            redrawAllConnections();
        }
    }

    // Make Draggable
    function makeDraggable(element) {
        element.addEventListener('mousedown', (e) => {
            if (e.target.closest('.connection-point') || e.target.closest('button')) return;

            isDragging = true;
            element.classList.add('dragging');

            const rect = element.getBoundingClientRect();
            const canvasRect = document.getElementById('canvasContent').getBoundingClientRect();

            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            function onMouseMove(e) {
                if (!isDragging) return;

                const canvasRect = document.getElementById('canvasContent').getBoundingClientRect();
                let newX = e.clientX - canvasRect.left - dragOffset.x;
                let newY = e.clientY - canvasRect.top - dragOffset.y;

                newX = Math.max(0, Math.min(newX, 3000 - element.offsetWidth));
                newY = Math.max(0, Math.min(newY, 3000 - element.offsetHeight));

                element.style.left = newX + 'px';
                element.style.top = newY + 'px';

                // Update all connections involving this component
                redrawAllConnections();
            }

            function onMouseUp() {
                isDragging = false;
                element.classList.remove('dragging');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }


    // Setup Connection Points
    function setupConnectionPoints(component) {
        const points = component.querySelectorAll('.connection-point');
        points.forEach(point => {
            point.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();

                console.log('Connection point clicked!', connectionMode ? 'Connection mode ON' : 'Connection mode OFF');

                if (connectionMode) {
                    if (!connectionStart) {
                        // First click - select starting point
                        connectionStart = { component, point };
                        point.classList.add('active');
                        console.log('Starting connection from:', component.dataset.id);
                    } else {
                        // Second click - create connection
                        if (connectionStart.component !== component) {
                            createConnection(connectionStart.component, component);
                            console.log('Connection created!');
                        } else {
                            console.log('Cannot connect component to itself');
                        }
                        connectionStart.point.classList.remove('active');
                        connectionStart = null;
                    }
                } else {
                    console.log('Please enable Connection Mode first by clicking the Connect button');
                }
            });
        });
    }

    // Create Connection
    function createConnection(fromComp, toComp) {
        const connection = {
            id: `conn-${connectionCounter}`,
            order: connectionCounter++,
            fromId: fromComp.dataset.id,
            toId: toComp.dataset.id,
            pathElement: null,
            labelElement: null
        };

        connections.push(connection);
        drawConnection(connection);
    }

    // Draw Connection
    function drawConnection(connection) {
        const fromComp = document.querySelector(`[data-id="${connection.fromId}"]`);
        const toComp = document.querySelector(`[data-id="${connection.toId}"]`);

        if (!fromComp || !toComp) return;

        const svg = document.getElementById('arrowSvg');
        const canvasRect = document.getElementById('canvasContent').getBoundingClientRect();

        const fromRect = fromComp.getBoundingClientRect();
        const toRect = toComp.getBoundingClientRect();

        const x1 = fromRect.left + fromRect.width / 2 - canvasRect.left;
        const y1 = fromRect.top + fromRect.height / 2 - canvasRect.top;
        const x2 = toRect.left + toRect.width / 2 - canvasRect.left;
        const y2 = toRect.top + toRect.height / 2 - canvasRect.top;

        // Create path
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const controlX = (x1 + x2) / 2;
        const controlY = (y1 + y2) / 2;
        const d = `M ${x1} ${y1} Q ${controlX} ${controlY} ${x2} ${y2}`;
        path.setAttribute('d', d);
        path.setAttribute('class', 'arrow-path');
        path.setAttribute('data-connection-id', connection.id);
        path.style.cursor = 'pointer';
        path.style.pointerEvents = 'stroke';

        // Add click handler to delete connection
        path.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`Delete connection #${connection.order}?`)) {
                deleteConnection(connection.id);
            }
        });

        // Create order label
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        const labelX = (x1 + x2) / 2;
        const labelY = (y1 + y2) / 2;
        text.setAttribute('x', labelX);
        text.setAttribute('y', labelY);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('class', 'connection-label');
        text.setAttribute('data-connection-id', connection.id);
        text.style.pointerEvents = 'none';
        text.innerHTML = `<tspan style="font-size: 14px; font-weight: 700; fill: white; stroke: #6366f1; stroke-width: 3; paint-order: stroke;">${connection.order}</tspan>`;

        // Remove old elements if they exist
        if (connection.pathElement) connection.pathElement.remove();
        if (connection.labelElement) connection.labelElement.remove();

        svg.appendChild(path);
        svg.appendChild(text);

        connection.pathElement = path;
        connection.labelElement = text;
    }

    // Delete Connection
    function deleteConnection(connectionId) {
        const connection = connections.find(c => c.id === connectionId);
        if (connection) {
            if (connection.pathElement) connection.pathElement.remove();
            if (connection.labelElement) connection.labelElement.remove();
            connections = connections.filter(c => c.id !== connectionId);
        }
    }

    // Redraw All Connections
    function redrawAllConnections() {
        connections.forEach(connection => {
            drawConnection(connection);
        });
    }


    // Toggle Connection Mode
    function toggleConnectionMode() {
        connectionMode = !connectionMode;
        const btn = document.getElementById('connectionMode');
        if (connectionMode) {
            btn.classList.add('active');
            console.log('✅ CONNECTION MODE ENABLED - Click connection points to create arrows');
        } else {
            btn.classList.remove('active');
            console.log('❌ CONNECTION MODE DISABLED');
            if (connectionStart) {
                connectionStart.point.classList.remove('active');
                connectionStart = null;
            }
        }
    }

    // Select Component
    function selectComponent(id) {
        document.querySelectorAll('.canvas-component').forEach(c => c.classList.remove('selected'));
        const component = document.querySelector(`[data-id="${id}"]`);
        component.classList.add('selected');
        selectedComponent = component;

        // Open properties panel
        document.getElementById('propertiesPanel').classList.add('open');
        document.getElementById('propType').value = component.dataset.type;
        document.getElementById('propTitle').value = component.querySelector('.component-title').textContent;
        document.getElementById('propDescription').value = component.querySelector('.component-description').textContent;
    }

    // Close Properties
    function closeProperties() {
        document.getElementById('propertiesPanel').classList.remove('open');
        if (selectedComponent) {
            selectedComponent.classList.remove('selected');
            selectedComponent = null;
        }
    }

    // Save Properties
    function saveProperties() {
        if (!selectedComponent) return;

        selectedComponent.querySelector('.component-title').textContent = document.getElementById('propTitle').value;
        selectedComponent.querySelector('.component-description').textContent = document.getElementById('propDescription').value;

        closeProperties();
    }

    // Initialize existing components
    document.querySelectorAll('.canvas-component').forEach(comp => {
        makeDraggable(comp);
        setupConnectionPoints(comp);
        comp.addEventListener('click', () => selectComponent(comp.dataset.id));
    });

    console.log('Visual Course Builder initialized - Drag components, connect them with arrows (with order numbers), and edit properties!');
    console.log('Click on arrows to delete connections. Order numbers show the sequence.');
</script>
{% endblock %}