{% extends "base.html" %}

{% block title %}Agentic Full Course - {{ course_title }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <!-- Hero -->
  <div class="bg-gradient-to-r from-indigo-600 to-blue-500 rounded-2xl shadow-2xl p-8 text-white mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div>
        <p class="text-sm uppercase tracking-widest text-indigo-100 font-semibold mb-1">Agentic output</p>
        <h1 class="text-3xl lg:text-4xl font-extrabold tracking-tight">{{ course_title }}</h1>
        <p class="text-indigo-100 mt-2">Generated end-to-end by the agent pipeline.</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-sm font-semibold">
          Audience: {{ audience or "—" }}
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-sm font-semibold">
          Tone: {{ tone or "—" }}
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-sm font-semibold">
          Duration: {{ duration_minutes or "—" }} min
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-sm font-semibold">
          Modules: {{ modules | length }}
        </span>
      </div>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">
      <!-- Overview -->
      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Overview</h2>
          <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Course meta</span>
        </div>
        <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-700">
          <div>
            <p class="font-semibold text-gray-900">Title</p>
            <p class="text-gray-700">{{ course_title }}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-900">Audience</p>
            <p class="text-gray-700">{{ audience or "—" }}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-900">Tone</p>
            <p class="text-gray-700">{{ tone or "—" }}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-900">Duration (min)</p>
            <p class="text-gray-700">{{ duration_minutes or "—" }}</p>
          </div>
        </div>
        <div class="mt-4">
          <p class="font-semibold text-gray-900 text-sm mb-2">Learning outcomes</p>
          <ul class="space-y-1 text-sm text-gray-700 list-disc list-inside">
            {% for outcome in learning_outcomes %}
            <li>{{ outcome }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Structure -->
      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Structure</h2>
          <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">CoursePlannerAgent</span>
        </div>
        <p class="text-sm text-gray-600 mb-4">Planned by the course planner, then expanded by the other agents.</p>
        <div class="space-y-3">
          {% for module in modules %}
          <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
            <div class="font-semibold text-gray-900">{{ module.title }}</div>
            <ul class="mt-2 ml-2 space-y-1 text-sm text-gray-700">
              {% for lesson in module.lessons %}
              <li class="flex items-start gap-2">
                <span class="text-indigo-500 mt-0.5">•</span>
                <span>Lesson: {{ lesson }}</span>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Artifacts -->
      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Artifacts (Preview)</h2>
          <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Generated</span>
        </div>
        <p class="text-sm text-gray-600 mb-4">Content generated by the pipeline. Videos are not rendered yet—review then
          finalize.</p>

        <div class="space-y-3">
          <details open class="border border-gray-100 rounded-xl bg-gray-50">
            <summary
              class="cursor-pointer flex items-center justify-between px-4 py-3 text-sm font-semibold text-gray-900">
              Lessons (LessonWriterAgent)
              <span class="text-xs text-gray-500">{{ lessons | length }} items</span>
            </summary>
            <div class="px-4 pb-4">
              <ul class="space-y-2 max-h-64 overflow-auto border border-gray-200 rounded-lg p-3 bg-white text-sm">
                {% for lesson in lessons %}
                <li>
                  <div class="font-semibold text-gray-900">{{ lesson.title }}</div>
                  <p class="text-gray-600 text-xs mt-1">{{ lesson.summary }}</p>
                </li>
                {% endfor %}
              </ul>
            </div>
          </details>

          <details class="border border-gray-100 rounded-xl bg-gray-50">
            <summary
              class="cursor-pointer flex items-center justify-between px-4 py-3 text-sm font-semibold text-gray-900">
              Quizzes (QuizAgent)
              <span class="text-xs text-gray-500">{{ quizzes | length }} total</span>
            </summary>
            <div class="px-4 pb-4 text-sm text-gray-700">
              <p class="text-xs text-gray-600 mb-1">Each lesson has an associated quiz; below are counts only.</p>
              <p class="text-gray-700">Total quizzes: {{ quizzes | length }}</p>
            </div>
          </details>

          <details class="border border-gray-100 rounded-xl bg-gray-50">
            <summary
              class="cursor-pointer flex items-center justify-between px-4 py-3 text-sm font-semibold text-gray-900">
              Videos (VideoScriptAgent / VideoGeneratorAgent)
              <span class="text-xs text-gray-500">{{ videos | length }} scripts</span>
            </summary>
            <div class="px-4 pb-4 text-sm text-gray-700">
              <p class="text-xs text-gray-600">
                Scripts are generated, but full narrated videos have not been rendered in this preview step.
              </p>
            </div>
          </details>
        </div>
      </div>

      <!-- Final Validation -->
      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Final Validation</h2>
          <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">ValidationAgent</span>
        </div>
        <p class="text-sm text-gray-600 mb-2">
          Status: <span class="font-mono font-semibold text-gray-900">{{ final_validation.status or "unknown" }}</span>
        </p>
        {% if final_validation.issues %}
        <p class="text-sm text-gray-600 mt-1">Issues noted:</p>
        <ul class="mt-1 list-disc list-inside text-xs text-gray-600">
          {% for issue in final_validation.issues %}
          <li>{{ issue }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-sm text-gray-600 mt-1">No issues reported.</p>
        {% endif %}
      </div>
    </div>

    <!-- Sticky CTA -->
    <div class="lg:col-span-1">
      <div class="sticky top-6 bg-white border border-gray-200 rounded-2xl shadow-lg p-6 space-y-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Finalize &amp; Render</h3>
          <p class="text-sm text-gray-600 mt-1">Render full videos and finalize the course when ready.</p>
        </div>
        <form id="finalize-form" method="post" action="/agentic-finalize/start" class="space-y-4">
          <input type="hidden" name="course_title" value="{{ course_title }}">
          <input type="hidden" name="audience" value="{{ audience or '' }}">
          <input type="hidden" name="tone" value="{{ tone or '' }}">
          <input type="hidden" name="duration_minutes" value="{{ duration_minutes or '' }}">
          {# Preserve original outcomes as text so we can re-parse them server-side #}
          <input type="hidden" name="learning_outcomes" value="{{ learning_outcomes | join('\\n') }}">

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Video Engine</label>
            <select name="video_engine"
              class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
              <option value="openai" {% if video_engine=='openai' %}selected{% endif %}>OpenAI (Standard)</option>
              <option value="gemini" {% if video_engine=='gemini' %}selected{% endif %}>Google Gemini 2.0 (Fast)
              </option>
            </select>
          </div>

          <label class="flex items-center space-x-3 text-sm text-gray-800">
            <input id="skip_video_finalize" name="skip_video" type="checkbox" value="true"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            <span>Skip Video Rendering (Fast Mode)</span>
          </label>

          <button type="submit"
            class="w-full px-4 py-3 font-semibold rounded-xl text-white bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-700 hover:to-emerald-700 shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Generate Videos &amp; Finalize Course
          </button>
        </form>
        <div class="text-xs text-gray-500 border-t border-gray-100 pt-3">
          This will render narrated videos from the generated scripts. Review artifacts above before finalizing.
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<div id="finalize-overlay" aria-hidden="true"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/35 backdrop-blur-sm pointer-events-none">
  <div
    class="w-full max-w-lg rounded-2xl bg-white shadow-2xl border border-slate-100 px-7 py-6 ring-1 ring-white/50 pointer-events-auto">
    <div class="flex items-center gap-4">
      <div
        class="relative flex items-center justify-center w-14 h-14 rounded-full bg-indigo-50 shadow-inner shadow-indigo-100">
        <div class="absolute inset-0 rounded-full border-4 border-indigo-100"></div>
        <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
      </div>
      <div>
        <p class="text-lg font-semibold text-gray-900">Generating…</p>
        <p id="finalize-status" class="text-sm text-gray-600">Agents are researching, planning, and rendering your
          course.</p>
      </div>
    </div>
    <div class="mt-4 bg-slate-50 border border-slate-100 rounded-xl p-3">
      <div class="flex items-center justify-between text-xs font-semibold text-slate-500 mb-1">
        <span id="finalize-step">Starting</span>
        <span id="finalize-progress-text">0%</span>
      </div>
      <div class="w-full bg-slate-200/70 rounded-full h-2 overflow-hidden">
        <div id="finalize-progress-bar"
          class="h-full bg-gradient-to-r from-indigo-500 to-emerald-500 transition-all duration-500 ease-out"
          style="width: 5%;"></div>
      </div>
    </div>
    <div class="mt-4 grid grid-cols-1 gap-2 text-sm text-gray-600">
      <div class="flex items-center gap-2">
        <span class="h-2 w-2 rounded-full bg-indigo-500 animate-pulse"></span>
        <span>Preparing scripts and narration</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="h-2 w-2 rounded-full bg-indigo-400 animate-pulse"></span>
        <span>Composing visuals and timing</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="h-2 w-2 rounded-full bg-indigo-300 animate-pulse"></span>
        <span>Rendering video outputs</span>
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const form = document.getElementById("finalize-form");
    const overlay = document.getElementById("finalize-overlay");
    const progressText = document.getElementById("finalize-progress-text");
    const progressBar = document.getElementById("finalize-progress-bar");
    const statusText = document.getElementById("finalize-status");
    const stepText = document.getElementById("finalize-step");
    if (!form || !overlay) return;
    let submitting = false;

    const updateOverlay = (progress, step, message) => {
      if (typeof progress === "number") {
        const pct = Math.min(100, Math.max(0, progress));
        if (progressBar) progressBar.style.width = `${pct}%`;
        if (progressText) progressText.textContent = `${pct}%`;
      }
      if (step && stepText) stepText.textContent = step;
      if (message && statusText) statusText.textContent = message;
    };

    async function pollStatus(jobId, retries = 0) {
      try {
        const res = await fetch(`/agentic-jobs/${jobId}`, { headers: { "Accept": "application/json" } });
        if (res.status === 404 && retries < 5) {
          setTimeout(() => pollStatus(jobId, retries + 1), 400);
          return;
        }
        if (!res.ok) throw new Error("Status fetch failed");
        const data = await res.json();
        updateOverlay(data.progress ?? 0, data.step || "Processing", data.message || "Generating…");
        if (data.status === "completed") {
          window.location.href = `/agentic-jobs/${jobId}/view`;
          return;
        }
        if (data.status === "failed") {
          alert(data.error || "Generation failed. Please try again.");
          overlay.classList.add("hidden");
          submitting = false;
          return;
        }
      } catch (err) {
        console.warn("Polling failed", err);
      }
      setTimeout(() => pollStatus(jobId, retries), 700);
    }

    form.addEventListener("submit", async (e) => {
      if (submitting) {
        e.preventDefault();
        return;
      }
      e.preventDefault();
      submitting = true;
      overlay.classList.remove("hidden");
      overlay.setAttribute("aria-hidden", "false");
      const startedAt = performance.now();

      const formData = new FormData(form);
      let jobId = null;
      try {
        const res = await fetch(form.action || "/agentic-finalize/start", {
          method: "POST",
          body: formData,
          headers: {
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        if (!res.ok) throw new Error("Failed to start finalize job");
        const payload = await res.json();
        jobId = payload.job_id;
      } catch (err) {
        console.error("Finalize start failed", err);
        alert("Could not start finalization. Please try again.");
        submitting = false;
        overlay.classList.add("hidden");
        return;
      }

      const elapsed = performance.now() - startedAt;
      const minVisible = 300;
      if (elapsed < minVisible) {
        await new Promise((resolve) => setTimeout(resolve, minVisible - elapsed));
      }

      if (jobId) {
        pollStatus(jobId);
      } else {
        overlay.classList.add("hidden");
        submitting = false;
      }
    });
  })();
</script>
{% endblock %}