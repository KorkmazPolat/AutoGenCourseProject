{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <style>
    .animate-fadeIn { animation: fadeIn 0.5s ease-in-out forwards; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

    /* Card hover effect */
    .form-card:hover, .stat-card:hover, #video-list > div:hover {
      transform: translateY(-2px) scale(1.02);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* Video list */
    #video-list { max-height: 300px; overflow-y: auto; padding-right:4px; }
    #video-list::-webkit-scrollbar { width:8px; }
    #video-list::-webkit-scrollbar-thumb { background-color: rgba(100,116,139,0.5); border-radius:4px; }
    #video-list > div { transition: transform 0.2s ease, box-shadow 0.2s ease; }

    /* Loading overlay */
    #loading-overlay { backdrop-filter: blur(2px); transition: opacity 0.3s ease; }
    #loading-overlay .bg-white { max-width: 400px; width: 90%; }

    #progress-bar { transition: width 0.2s ease; }

    /* Input focus */
    #course-form input:focus,
    #course-form textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79,70,229,0.3); }

    /* Buttons hover */
    #course-form button:hover { transform: scale(1.03); transition: transform 0.2s ease; }

    /* Make dashboard and form same width */
    .dashboard-form-wrapper { max-width: 800px; width: 100%; }
  </style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col items-center justify-start space-y-10 py-10">

  <div class="dashboard-form-wrapper w-full flex flex-col items-center space-y-10">

    <!-- Dashboard Section -->
    <div class="bg-gray-50 p-8 rounded-3xl shadow-inner w-full">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow stat-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Courses Created</h3>
          <p class="text-3xl font-bold text-gray-900" id="courses-count">0</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow stat-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Videos Generated</h3>
          <p class="text-3xl font-bold text-gray-900" id="videos-count">0</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow stat-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Pending Tasks</h3>
          <p class="text-3xl font-bold text-gray-900" id="tasks-count">0</p>
        </div>
      </div>

      <!-- Video List -->
      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Generated Videos</h3>
        <div id="video-list" class="space-y-4"></div>
      </div>
    </div>

    <!-- Form Card -->
    <div class="bg-white shadow-2xl rounded-3xl p-10 form-card w-full">
      <div class="text-center mb-8">
        <img src="{{ url_for('static', path='logo.png') }}" alt="AutoGenCourse Logo" class="mx-auto w-32 h-32 object-contain mb-4">
        <p class="text-gray-600 text-lg">Enter your course details and watch it come to life! Professional, fast, and user-friendly.</p>
      </div>

      <form id="course-form" method="post" action="/create-course-plan" class="space-y-5">
        {% for field in ['course_title', 'audience', 'tone', 'duration_minutes'] %}
        <div>
          <label class="block text-gray-700 font-semibold mb-1" for="{{ field }}">{{ field.replace('_', ' ') | title }}</label>
          <input id="{{ field }}" name="{{ field }}" type="{{ 'number' if field=='duration_minutes' else 'text' }}" 
                 placeholder="Enter {{ field.replace('_', ' ') }}" 
                 class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-400 focus:outline-none" 
                 value="{{ values.get(field,'') }}">
        </div>
        {% endfor %}

        <div>
          <label class="block text-gray-700 font-semibold mb-1" for="learning_outcomes">Learning Outcomes</label>
          <textarea id="learning_outcomes" name="learning_outcomes" rows="5" 
                    placeholder="- Explain why prompt design matters
- Compare prompting patterns
- Use prompts to debug failures"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-400 focus:outline-none resize-none">{{ values.get('learning_outcomes','') }}</textarea>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 mt-4">
          <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold py-3 rounded-xl shadow-lg">Create Course Plan</button>
          <button type="submit" formaction="/create-course-pages" class="flex-1 border border-blue-500 text-blue-500 font-bold py-3 rounded-xl hover:bg-blue-50 transition">Build Module Pages</button>
          <button type="submit" formaction="/create-course-video" class="flex-1 border border-purple-500 text-purple-500 font-bold py-3 rounded-xl hover:bg-purple-50 transition">Generate Video</button>
        </div>
      </form>
    </div>

  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-96 max-w-[90vw] text-center animate-fadeIn">
      <h2 class="text-2xl font-bold mb-4">Creating your content…</h2>
      <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full w-0 bg-gradient-to-r from-blue-500 to-purple-500"></div>
      </div>
      <p id="progress-text" class="mt-2 font-mono text-gray-700">0%</p>
      <p id="progress-hint" class="mt-2 text-gray-500">Drafting materials…</p>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const form = document.getElementById('course-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressHint = document.getElementById('progress-hint');
    const videoList = document.getElementById('video-list');
    const coursesCount = document.getElementById('courses-count');
    const videosCount = document.getElementById('videos-count');

    function showLoading(){
      loadingOverlay.classList.remove('hidden');
      let pct = 0;
      const hints = ['Drafting…','Rendering…','Finalizing…'];
      let step=0;
      const interval = setInterval(()=>{
        if(pct<100){
          pct += Math.floor(Math.random()*5)+1;
          progressBar.style.width=Math.min(pct,100)+'%';
          progressText.textContent=Math.min(pct,100)+'%';
          progressHint.textContent=hints[step];
          if(pct>30 && step===0) step++;
          if(pct>60 && step===1) step++;
          if(pct>=100) clearInterval(interval);
        }
      },200);
    }

    function hideLoading(){
      loadingOverlay.classList.add('hidden');
      progressBar.style.width='0%';
      progressText.textContent='0%';
      progressHint.textContent='';
    }

    function addVideoCard(html){
      const div = document.createElement('div');
      div.innerHTML = html;
      div.classList.add('p-4','border','border-gray-300','rounded-xl','hover:shadow','transition');
      videoList.prepend(div);
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      showLoading();
      const fd = new FormData(form);
      try{
        const response = await fetch(form.action,{method:'POST',body:fd});
        const html = await response.text();
        hideLoading();
        addVideoCard(html);
        coursesCount.textContent = parseInt(coursesCount.textContent||0)+1;
      }catch(err){
        console.error(err);
        hideLoading();
        alert('Error creating course');
      }
    });
  </script>
{% endblock %}
