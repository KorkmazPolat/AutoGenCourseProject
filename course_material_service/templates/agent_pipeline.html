{% extends "base.html" %}

{% block title %}Agentic Course Pipeline{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-900 mb-6">Agentic Course Generation Pipeline</h1>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Input Panel -->
    <section class="lg:col-span-1 bg-white shadow rounded-xl p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Design Your Course</h2>
      <form id="pipeline-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="learning_outcomes">
            Learning Outcomes
          </label>
          <textarea
            id="learning_outcomes"
            name="learning_outcomes"
            rows="8"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="- Understand Python basics&#10;- Write simple functions&#10;- Use loops effectively"
          ></textarea>
        </div>
        <button
          type="submit"
          class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none"
        >
          Start Agentic Generation
        </button>
        <p id="pipeline-error" class="text-sm text-red-600 hidden mt-2"></p>
      </form>
    </section>

    <!-- Pipeline Visualization -->
    <section class="lg:col-span-2 space-y-4">
      <!-- Agent timeline -->
      <div class="bg-white shadow rounded-xl p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Pipeline Execution</h2>

        <div id="pipeline-status" class="space-y-4">
          <p class="text-sm text-gray-600" id="pipeline-intro">
            Submit learning outcomes to see the end-to-end agent workflow. Each node becomes active as the service progresses.
          </p>

          <div class="flex flex-col md:flex-row gap-8">
            <!-- Tree -->
            <div class="flex-1">
              <ol class="border-l-2 border-gray-200 pl-4 space-y-4 text-sm" id="pipeline-tree">
                <li data-step="plan" class="pipeline-step">
                  <div class="flex items-start gap-2">
                    <span class="mt-1 w-3 h-3 rounded-full bg-gray-300 status-dot"></span>
                    <div>
                      <p class="font-semibold text-gray-800">CoursePlannerAgent</p>
                      <p class="text-gray-500">Designs high-level course plan (modules &amp; lessons).</p>
                    </div>
                  </div>
                </li>
                <li data-step="lesson" class="pipeline-step">
                  <div class="flex items-start gap-2">
                    <span class="mt-1 w-3 h-3 rounded-full bg-gray-300 status-dot"></span>
                    <div>
                      <p class="font-semibold text-gray-800">LessonWriterAgent</p>
                      <p class="text-gray-500">Expands each lesson into full LessonContent.</p>
                    </div>
                  </div>
                </li>
                <li data-step="video_script" class="pipeline-step">
                  <div class="flex items-start gap-2">
                    <span class="mt-1 w-3 h-3 rounded-full bg-gray-300 status-dot"></span>
                    <div>
                      <p class="font-semibold text-gray-800">VideoScriptAgent</p>
                      <p class="text-gray-500">Transforms lessons into scene-based video scripts.</p>
                    </div>
                  </div>
                </li>
                <li data-step="quiz" class="pipeline-step">
                  <div class="flex items-start gap-2">
                    <span class="mt-1 w-3 h-3 rounded-full bg-gray-300 status-dot"></span>
                    <div>
                      <p class="font-semibold text-gray-800">QuizAgent</p>
                      <p class="text-gray-500">Generates MCQ quizzes aligned with each lesson.</p>
                    </div>
                  </div>
                </li>
                <li data-step="video" class="pipeline-step">
                  <div class="flex items-start gap-2">
                    <span class="mt-1 w-3 h-3 rounded-full bg-gray-300 status-dot"></span>
                    <div>
                      <p class="font-semibold text-gray-800">VideoGeneratorAgent</p>
                      <p class="text-gray-500">Renders narrated videos from scripts (MoviePy + TTS).</p>
                    </div>
                  </div>
                </li>
                <li data-step="validate" class="pipeline-step">
                  <div class="flex items-start gap-2">
                    <span class="mt-1 w-3 h-3 rounded-full bg-gray-300 status-dot"></span>
                    <div>
                      <p class="font-semibold text-gray-800">ValidationAgent</p>
                      <p class="text-gray-500">Runs structural checks and LLM-based correction over the full course.</p>
                    </div>
                  </div>
                </li>
              </ol>
            </div>

            <!-- Live log -->
            <div class="flex-1">
              <div class="bg-gray-50 border border-gray-200 rounded-lg h-64 overflow-auto text-xs font-mono p-3" id="pipeline-log">
                <p class="text-gray-500">Waiting for a run...</p>
              </div>
            </div>
          </div>

          <!-- Summary -->
          <div id="pipeline-summary" class="mt-4 hidden">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Run Summary</h3>
            <p class="text-xs text-gray-600 mb-1">
              <span class="font-semibold">Modules:</span> <span id="summary-modules">0</span>,
              <span class="font-semibold">Lessons:</span> <span id="summary-lessons">0</span>,
              <span class="font-semibold">Videos:</span> <span id="summary-videos">0</span>,
              <span class="font-semibold">Quizzes:</span> <span id="summary-quizzes">0</span>
            </p>
            <p class="text-xs text-gray-600">
              <span class="font-semibold">Final validation status:</span>
              <span id="summary-status">-</span>
            </p>
          </div>
        </div>
      </div>

      <!-- System tree visualization -->
      <div class="bg-white shadow rounded-xl p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">System Tree</h2>
        <p class="text-sm text-gray-600 mb-3">
          Visual overview of how the AgentManager coordinates each agent to generate a full course.
        </p>
        <!-- Static topology -->
        <div class="text-sm mb-4">
          <ul class="space-y-2">
            <li>
              <div class="font-semibold text-gray-900">AgentManager</div>
              <ul class="mt-1 ml-4 space-y-1 text-gray-800">
                <li>
                  <span class="font-medium">1. CoursePlannerAgent</span>
                  <span class="ml-1 text-xs text-gray-500">Designs CoursePlan (modules &amp; lessons)</span>
                </li>
                <li>
                  <span class="font-medium">2. Per-module &amp; per-lesson pipeline</span>
                  <ul class="mt-1 ml-4 space-y-1 text-gray-700">
                    <li>
                      <span class="font-medium">LessonWriterAgent</span>
                      <span class="ml-1 text-xs text-gray-500">→ LessonContent</span>
                    </li>
                    <li>
                      <span class="font-medium">VideoScriptAgent</span>
                      <span class="ml-1 text-xs text-gray-500">→ VideoScript (scenes)</span>
                    </li>
                    <li>
                      <span class="font-medium">QuizAgent</span>
                      <span class="ml-1 text-xs text-gray-500">→ Quiz (MCQs)</span>
                    </li>
                    <li>
                      <span class="font-medium">VideoGeneratorAgent</span>
                      <span class="ml-1 text-xs text-gray-500">→ video_path (MoviePy + TTS)</span>
                    </li>
                  </ul>
                </li>
                <li>
                  <span class="font-medium">3. ValidationAgent</span>
                  <span class="ml-1 text-xs text-gray-500">Validates &amp; auto-fixes plan, lessons, scripts, quizzes, and final bundle</span>
                </li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Per-run communication tree -->
        <div class="border-t border-gray-200 pt-4">
          <h3 class="text-sm font-semibold text-gray-800 mb-2">This Run: Agent Communication</h3>
          <p class="text-xs text-gray-500 mb-2" id="agent-tree-empty">
            Run the pipeline to see how AgentManager called each agent for this course.
          </p>
          <div id="agent-tree" class="hidden text-xs"></div>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById("pipeline-form");
  const errorEl = document.getElementById("pipeline-error");
  const logEl = document.getElementById("pipeline-log");
  const summaryEl = document.getElementById("pipeline-summary");
  const agentTreeEl = document.getElementById("agent-tree");
  const agentTreeEmptyEl = document.getElementById("agent-tree-empty");

  const stepsOrder = ["plan", "lesson", "video_script", "quiz", "video", "validate"];

  function resetPipelineUI() {
    document.querySelectorAll(".pipeline-step .status-dot").forEach(dot => {
      dot.classList.remove("bg-green-500", "bg-blue-500", "bg-gray-300");
      dot.classList.add("bg-gray-300");
    });
    logEl.innerHTML = '<p class="text-gray-500">Starting new run...</p>';
    summaryEl.classList.add("hidden");
    errorEl.classList.add("hidden");
    errorEl.textContent = "";
    if (agentTreeEl) {
      agentTreeEl.classList.add("hidden");
      agentTreeEl.innerHTML = "";
    }
    if (agentTreeEmptyEl) {
      agentTreeEmptyEl.classList.remove("hidden");
    }
  }

  function markStep(step, state) {
    const li = document.querySelector('.pipeline-step[data-step="' + step + '"]');
    if (!li) return;
    const dot = li.querySelector(".status-dot");
    dot.classList.remove("bg-green-500", "bg-blue-500", "bg-gray-300");
    if (state === "active") {
      dot.classList.add("bg-blue-500");
    } else if (state === "done") {
      dot.classList.add("bg-green-500");
    } else {
      dot.classList.add("bg-gray-300");
    }
  }

  function appendLog(message) {
    const line = document.createElement("p");
    line.textContent = message;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function runPipeline(outcomes) {
    resetPipelineUI();

    // Progressively mark steps as active while the backend processes.
    stepsOrder.forEach(step => markStep(step, "idle"));

    try {
      appendLog("[client] Sending /generate-course request...");
      markStep("plan", "active");

      const response = await fetch("/generate-course", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ learning_outcomes: outcomes }),
      });

      if (!response.ok) {
        throw new Error("Backend returned status " + response.status);
      }

      const result = await response.json();

      // Animate remaining steps quickly to reflect full pipeline completion.
      const delay = ms => new Promise(res => setTimeout(res, ms));
      const remaining = stepsOrder.slice(1);
      for (const s of remaining) {
        markStep(s, "active");
        appendLog("[client] " + s + " stage completed.");
        await delay(150);
        markStep(s, "done");
      }
      markStep("plan", "done");

      const modules = (result.course_plan?.modules || []).length;
      const lessons = (result.lessons || []).length;
      const videos = (result.videos || []).length;
      const quizzes = (result.quizzes || []).length;
      const status = result.final_validation?.status || "unknown";

      document.getElementById("summary-modules").textContent = modules;
      document.getElementById("summary-lessons").textContent = lessons;
      document.getElementById("summary-videos").textContent = videos;
      document.getElementById("summary-quizzes").textContent = quizzes;
      document.getElementById("summary-status").textContent = status;
      summaryEl.classList.remove("hidden");

      renderAgentCommunicationTree(result);

      appendLog("[client] Pipeline finished. Validation status: " + status);
    } catch (err) {
      errorEl.textContent = err.message || "Unexpected error during pipeline run.";
      errorEl.classList.remove("hidden");
      appendLog("[client] Error: " + errorEl.textContent);
    }
  }

  form.addEventListener("submit", function (event) {
    event.preventDefault();
    const raw = document.getElementById("learning_outcomes").value || "";
    const outcomes = raw
      .split("\n")
      .map(line => line.replace(/^[-•]\s*/, "").trim())
      .filter(Boolean);

    if (!outcomes.length) {
      errorEl.textContent = "Please provide at least one learning outcome.";
      errorEl.classList.remove("hidden");
      return;
    }

    runPipeline(outcomes);
  });

  function renderAgentCommunicationTree(result) {
    if (!agentTreeEl) return;

    agentTreeEl.innerHTML = "";
    if (agentTreeEmptyEl) {
      agentTreeEmptyEl.classList.add("hidden");
    }
    agentTreeEl.classList.remove("hidden");

    const plan = result.course_plan || {};
    const modules = plan.modules || [];

    const root = document.createElement("ul");
    root.className = "space-y-1";

    const rootLi = document.createElement("li");
    const rootHeader = document.createElement("div");
    rootHeader.className = "font-semibold text-gray-900";
    rootHeader.textContent = "AgentManager (orchestrator)";
    rootLi.appendChild(rootHeader);

    const rootChildren = document.createElement("ul");
    rootChildren.className = "ml-4 space-y-1";

    // Planner call
    const plannerLi = document.createElement("li");
    plannerLi.textContent = "calls CoursePlannerAgent → returns CoursePlan";
    rootChildren.appendChild(plannerLi);

    // Per-lesson loop
    const loopLi = document.createElement("li");
    loopLi.textContent = `loops over ${modules.length || 0} module(s) and their lessons:`;

    const loopChildren = document.createElement("ul");
    loopChildren.className = "ml-4 space-y-1";

    const lessonWriterLi = document.createElement("li");
    lessonWriterLi.textContent = "for each lesson: LessonWriterAgent → LessonContent";
    loopChildren.appendChild(lessonWriterLi);

    const scriptLi = document.createElement("li");
    scriptLi.textContent = "for each lesson: VideoScriptAgent → VideoScript";
    loopChildren.appendChild(scriptLi);

    const quizLi = document.createElement("li");
    quizLi.textContent = "for each lesson: QuizAgent → Quiz";
    loopChildren.appendChild(quizLi);

    const videoLi = document.createElement("li");
    videoLi.textContent = "for each lesson: VideoGeneratorAgent → video_path";
    loopChildren.appendChild(videoLi);

    loopLi.appendChild(loopChildren);
    rootChildren.appendChild(loopLi);

    // Validation agent calls
    const validationLi = document.createElement("li");
    validationLi.textContent = "calls ValidationAgent on plan, each artifact, and final bundle";
    rootChildren.appendChild(validationLi);

    rootLi.appendChild(rootChildren);
    root.appendChild(rootLi);

    agentTreeEl.appendChild(root);
  }
</script>
{% endblock %}
