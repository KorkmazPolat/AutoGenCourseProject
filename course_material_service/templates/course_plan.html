{% extends "base.html" %}

{% block title %}{{ course_title }} - Course Plan - ALPHA{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-2xl p-8 md:p-10 mb-10">
  <div class="flex items-start justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">{{ course_title }}</h1>
      {% if blueprint.overview %}
      <p class="text-gray-600 mt-2">{{ blueprint.overview.positioning }}</p>
      <ul class="mt-3 text-gray-700 space-y-1">
        <li><span class="font-semibold">Audience:</span> {{ blueprint.overview.target_audience }}</li>
        <li><span class="font-semibold">Total time:</span> {{ blueprint.overview.total_duration_hours }}</li>
        <li><span class="font-semibold">Pacing:</span> {{ blueprint.overview.pacing_strategy }}</li>
      </ul>
      {% if blueprint.overview.prerequisites %}
      <p class="text-sm text-gray-500 mt-1">Prerequisites: {{ blueprint.overview.prerequisites | join(", ") }}</p>
      {% endif %}
      {% endif %}
    </div>
    <a href="/dashboard" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">Back</a>
  </div>

  {% if learning_outcomes %}
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-3">Learning Outcomes</h2>
    <ul class="list-disc pl-6 text-gray-700">
      {% for outcome in learning_outcomes %}
      <li>{{ outcome }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Modules</h2>
    {% if blueprint.modules %}
    <div class="space-y-4">
      {% for module in blueprint.modules %}
      <div class="rounded-xl border border-gray-200 bg-gray-50 p-5">
        <h3 class="text-xl font-semibold text-gray-800">Module {{ module.number }}: {{ module.title }}</h3>
        {% if module.summary %}<p class="text-gray-700 mt-1">{{ module.summary }}</p>{% endif %}
        {% if module.outcomes %}
        <p class="mt-2 text-gray-700"><span class="font-semibold">Outcomes:</span> {{ module.outcomes | join(", ") }}</p>
        {% endif %}
        {% if module.key_topics %}
        <p class="text-gray-700"><span class="font-semibold">Key topics:</span> {{ module.key_topics | join(", ") }}</p>
        {% endif %}
        {% if module.learning_activities %}
        <p class="text-gray-800 font-semibold mt-2">Activities</p>
        <ul class="list-disc pl-6 text-gray-700">
          {% for activity in module.learning_activities %}
          <li>
            {{ activity.activity_type }} — {{ activity.description }} {% if activity.duration_minutes %}<span class="text-gray-500">({{ activity.duration_minutes }} min)</span>{% endif %}
          </li>
          {% endfor %}
        </ul>
        {% endif %}
        {% if module.assessment %}
        <p class="mt-2 text-gray-700"><span class="font-semibold">Assessment:</span> {{ module.assessment.format }} — {{ module.assessment.description }}</p>
        {% endif %}
        {% if module.project_milestone %}
        <p class="text-gray-700"><span class="font-semibold">Project milestone:</span> {{ module.project_milestone }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-600">No modules were generated.</p>
    {% endif %}
  </div>

  <form method="post" action="/create-course-pages" class="mt-6">
    <input type="hidden" name="course_title" value="{{ course_title }}" />
    <input type="hidden" name="audience" value="{{ audience or '' }}" />
    <input type="hidden" name="tone" value="{{ tone or '' }}" />
    <input type="hidden" name="duration_minutes" value="{{ duration_minutes or '' }}" />
    <textarea name="learning_outcomes" hidden>{{ learning_outcomes_text }}</textarea>
    <textarea name="blueprint_json" hidden>{{ blueprint | tojson }}</textarea>
    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg">Build module pages</button>
  </form>

  <p class="text-gray-500 text-sm mt-3">When you continue, we'll generate simple materials for each module based on this plan.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
      const form = document.querySelector('form[action="/create-course-pages"]');
      if (!form) return;
      function overlay() {
        const el = document.createElement('div');
        el.style.position = 'fixed';
        el.style.inset = '0';
        el.style.background = 'rgba(255,255,255,0.9)';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.zIndex = '9999';
        const inner = document.createElement('div');
        inner.style.padding = '20px';
        inner.style.border = '1px solid #d2d6dc';
        inner.style.background = '#fff';
        inner.innerHTML = '<strong>Building module pages…</strong><div style="height:10px;background:#eef2f7;border:1px solid #d2d6dc;margin-top:8px;position:relative;border-radius:6px;overflow:hidden"><div id="pb" style="height:100%;width:0;background:#2563eb;transition:width 250ms ease"></div></div><div id="pt" style="margin-top:6px;color:#52606d;font-family:monospace">0%</div>';
        el.appendChild(inner);
        document.body.appendChild(el);
        return el;
      }
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const ov = overlay();
        const bar = ov.querySelector('#pb');
        const txt = ov.querySelector('#pt');
        let p = 0; const t = setInterval(() => { p = Math.min(95, p + 2); bar.style.width = p + '%'; txt.textContent = p + '%'; }, 200);
        fetch('/create-course-pages', { method: 'POST', body: new FormData(form), credentials: 'same-origin' })
          .then(r => r.text())
          .then(html => { clearInterval(t); bar.style.width = '100%'; txt.textContent = '100%'; document.open(); document.write(html); document.close(); })
          .catch(() => { clearInterval(t); txt.textContent = 'Error. Please retry.'; txt.style.color = '#b91c1c'; });
      });
    })();
  </script>
{% endblock %}
